<?php
use \Tuanduimao\Loader\App;
?>
<div class="webtable-content">
	<div id="gallery-table" class="webtable"></div>
	<div class="row webtable-footer">
		<div class="col-xs-5">
			<button class="btn btn-primary  push-15-t push-15-l"> 
				<i class="fa fa-save"></i> 保存</button>
			<button class="btn btn-primary  push-15-t push-10-l"> 
				<i class="fa fa-cloud-upload"></i> 导入</button>
		</div>
		<div class="col-xs-7 text-muted text-right" style="padding:15px 15px 5px 15px;">
			 <nav class="push-15-r remove-padding " >
				<ul class="pagination remove-padding remove-margin">
					<li class="disabled">
						<a href="javascript:void(0)"><i class="fa fa-angle-double-left"></i></a>
					</li>
					<li class="active">
						<a href="javascript:void(0)">1</a>
					</li>
					<li>
						<a href="javascript:void(0)">2</a>
					</li>
					<li>
						<a href="javascript:void(0)">3</a>
					</li>
					<li>
						<a href="javascript:void(0)">4</a>
					</li>
					<li>
						<a href="javascript:void(0)">5</a>
					</li>
					<li>
						<a href="javascript:void(0)"><i class="fa fa-angle-double-right"></i></a>
					</li>
				</ul>
			</nav>
		</div>
	</div>
</div>
<script type="text/javascript">

	$imgeditor.display();
	$imgeditor.mode('modify');
	$imgeditor.crumb([{name:'批量编辑'}]);

	var image = { page:[], items:[] };

	$('#gallery-table').webtable({
	   offsetHeight:222,
	   readOnly:false,
	   submitOption:{
		   'url': '<?=App::NR('gallery', 'save')?>'
	   },

	   afterChange:function( changes, source){
		   if ( changes == null  ) return;
		   var last = changes.slice(-1)[0];
           var index = last[0] || 0;
           preview(index);
	   },

       afterGetdata: function( resp, status, xhr ){
            $hot.selectCell(0,0);
       }

	});

	var $webtable = $('#gallery-table').webtable('get');
	var $hot = $webtable.handsontable();
        $hot.latest = -1;
   
	$webtable.getData('<?=App::NR('gallery', 'getdata')?>', function( resp, status, xhr){
		console.log('getdata success', resp ); 
		console.log('getdata pagination', resp['pagination'] );  // 分页信息
		console.log('getdata status', resp['status'] );  // 状态信息
		console.log( resp );


		updateColumsSelector( resp['columns'], resp['colHeaders'] );
		updateImage( resp['image'] );
		return resp;
	});



	// @see https://docs.handsontable.com/0.15.0-beta3/Hooks.html
	$hot.addHook('afterSelectionEnd', function( index ){
		
		if ( $hot.latest == index ) {
			return;
		}

        $hot.latest = index; 
        preview( index );
	});


	/**
	 * 更新栏位选择器
	 * @param  {[type]} columns    [description]
	 * @param  {[type]} colHeaders [description]
	 * @return {[type]}            [description]
	 */
	function updateColumsSelector( columns , colHeaders ) {
		colHeaders = colHeaders || [];

		$('select[name=origin]').Select2Option().clean();
		$('select[name=origin]').Select2Option().add('', '');
		for( var col in columns ) {
			var name = colHeaders[col] || columns[col]['name'];
			$('select[name=origin]').Select2Option().add(name, col);
		}
	}


	/**
	 * 更新图片信息
	 * @param  {[type]} data [description]
	 * @return {[type]}      [description]
	 */
	function updateImage( data ) {
		image = data;
	}



    function preview( index ) {

        var data = $hot.getDataAtRow( index );
        var page = image['page'] || [];
        var items = image['items'] || [];

        // 忽略空行
        if ( data.join('') == "" ) {
        	return;
        }


        $imgeditor.setIndex( index );
        $imgeditor.clean();

        if ( typeof page['origin'] == 'number' && data[page['origin']] != null) {
        	image['page']['bgimage'] = data[page['origin']];
        }

        $imgeditor.updatePage( page , function(){
	        for( var idx in items ) {
	        	var it = items[idx];
	        		it[0] = it[0] || '';
	        		it[1] = it[1] || [];
	        		it[2] = it[2] || [];

	        	var origin = it[1]['origin'];

	        	if ( it[0] == 'image' ) {
	        		if ( typeof origin == 'number' && data[origin] != null) {
	        			it[1]['src'] = data[origin];
			        }	
	        	} else if ( it[0] == 'text' ) {
	        		if ( typeof origin == 'number' && data[origin] != null) {
	        			it[1]['text'] = data[origin];
			        }
	        	} else if ( it[0] == 'qrcode' ) {
	        		if ( typeof origin == 'number' && data[origin] != null) {
	        			it[1]['text'] = data[origin];
			        }
	        	}

	        	$imgeditor.add(it[0], it[1], it[2] );
	        	console.log( 'it=', it);
	        }
        })
    }
   

</script>